version: "3.8"

# Este archivo define la aplicación Spring Boot y una instancia de MySQL
# para ser ejecutadas en el mismo entorno de host (ej. Docker local, Azure Container Apps, o una única VM).
# NOTA CRÍTICA: Los datos se almacenan en un volumen local (db_data). Si el host o el volumen
# es desechado/reiniciado, los datos de MySQL SE PERDERÁN.
services:
  # 1. SERVICIO DE LA APLICACIÓN SPRING BOOT
  inti-wasi-platform:
    # 'build: .' le dice a Docker Compose que use su Dockerfile existente
    # para construir la imagen de la aplicación Java.
    build:
      context: .
      dockerfile: Dockerfile
    image: intiwasi/spring-app
    container_name: inti-wasi-platform
    
    # Mapea el puerto 8080 del contenedor al puerto 8080 del host
    ports:
      - "8080:8080"
      
    # Variables de entorno para la aplicación Java
    environment:
      # La URL de la DB ahora apunta al nombre del servicio 'mysql-db'
      DB_URL: jdbc:mysql://mysql-db:3306/intiwasi_local?allowPublicKeyRetrieval=true&useSSL=false
      DB_USERNAME: ${DB_USERNAME:-inti_user} # Usa variable de entorno, si no existe usa 'inti_user'
      DB_PASSWORD: ${DB_PASSWORD:-local_password} # Usa variable de entorno, si no existe usa 'local_password'
      JWT_SECRET: ${JWT_SECRET:-ThisIsALongAndVerySecureSecretForJWT}
      SERVER_PORT: 8080
      CORS_ALLOWED_ORIGINS: "*"
    
    # Asegura que la aplicación espere a que la base de datos esté lista
    depends_on:
      - mysql-db

  # 2. SERVICIO DE LA BASE DE DATOS MYSQL
  mysql-db:
    image: mysql:8.0 # Versión estable y recomendada de MySQL
    container_name: mysql-db
    
    # Variables de entorno de MySQL para el contenedor
    environment:
      # Variables que usa la imagen de MySQL para inicializar la base de datos:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_admin_password}
      MYSQL_DATABASE: intiwasi_local
      MYSQL_USER: ${DB_USERNAME:-inti_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-local_password}

    # Persistencia de datos: Mapea un volumen (db_data) al directorio de datos de MySQL.
    # Los datos se mantendrán entre reinicios del contenedor, pero NO entre reinicios del host.
    volumes:
      - db_data:/var/lib/mysql

# Definición de volúmenes persistentes
volumes:
  db_data:
